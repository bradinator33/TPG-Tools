<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Random US Coordinates Generator</title>
    <!-- Leaflet for the map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <!-- Turf.js for geospatial analysis -->
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <style>
        body { font-family: sans-serif; padding: 1em; }
        #map {
            width: 100%;
            height: 700px;
            margin-top: 1em;
            border: 1px solid #ccc;
        }
        #stateSelector {
            width: 250px;
            height: 200px;
            vertical-align: top;
        }
        label {
            display: block;
            margin-top: 1em;
            font-weight: bold;
        }
        button {
            margin-top: 1em;
        }
        #output {
            margin-top: 1em;
            font-family: monospace;
            font-size: 1.1em;
            background-color: #f4f4f4;
            padding: 0.5em;
            border: 1px solid #ddd;
        }
        #loader {
            display: none;
            margin-top: 1em;
            font-style: italic;
            color: #555;
        }
    </style>
</head>
<body onload="initMap()">

    <h1>Random US Coordinates Generator</h1>
    <h3>Select a region or individual states. Leave blank to generate a location anywhere in the US.</h3>

    <label for="regionSelector">Region Presets:</label>
    <select id="regionSelector">
        <option value="">-- Select a Region --</option>
        <option value="midwest">Midwest</option>
        <option value="west">West</option>
        <option value="south">South</option>
        <option value="new_england">New England</option>
        <option value="mid_atlantic">Mid-Atlantic</option>
        <option value="territories">US Territories</option>
    </select>

    <div>
        <label for="stateSelector">Select States (Hold Ctrl/Cmd to select multiple):</label>
        <select id="stateSelector" multiple>
            <!-- Options will be populated by JavaScript -->
        </select>
    </div>
    
    <button id="clearSelectionBtn">Clear Selection</button>
    <br>
    <button id="generateBtn">Generate Random Location</button>

    <div id="output">Click the button to generate coordinates.</div>
    <div id="loader">Finding a valid point...</div>

    <div id="map"></div>

    <script>
        // --- GLOBALS ---
        let map;
        let currentPin = null;
        let boundaryLayer = null;
        const stateGeoJsonCache = new Map(); // Cache for fetched GeoJSON files

        const stateNames = [
            "Alabama", "Alaska", "Arizona", "Arkansas", "California", "Colorado", "Connecticut", "Delaware", "Florida", "Georgia",
            "Hawaii", "Idaho", "Illinois", "Indiana", "Iowa", "Kansas", "Kentucky", "Louisiana", "Maine", "Maryland",
            "Massachusetts", "Michigan", "Minnesota", "Mississippi", "Missouri", "Montana", "Nebraska", "Nevada", "New Hampshire", "New Jersey",
            "New Mexico", "New York", "North Carolina", "North Dakota", "Ohio", "Oklahoma", "Oregon", "Pennsylvania", "Rhode Island", "South Carolina",
            "South Dakota", "Tennessee", "Texas", "Utah", "Vermont", "Virginia", "Washington", "West Virginia", "Wisconsin", "Wyoming",
            "American Samoa", "Guam", "Northern Mariana Islands", "Puerto Rico", "U.S. Virgin Islands"
        ];
        
        const regionPresets = {
            midwest: ["Illinois", "Indiana", "Iowa", "Kansas", "Michigan", "Minnesota", "Missouri", "Nebraska", "North Dakota", "Ohio", "South Dakota", "Wisconsin"],
            west: ["Arizona", "California", "Colorado", "Idaho", "Montana", "Nevada", "New Mexico", "Oregon", "Utah", "Washington", "Wyoming"],
            south: ["Alabama", "Arkansas", "Delaware", "Florida", "Georgia", "Kentucky", "Louisiana", "Maryland", "Mississippi", "North Carolina", "Oklahoma", "South Carolina", "Tennessee", "Texas", "Virginia", "West Virginia"],
            new_england: ["Connecticut", "Maine", "Massachusetts", "New Hampshire", "Rhode Island", "Vermont"],
            mid_atlantic: ["Delaware", "Maryland", "New Jersey", "New York", "Pennsylvania", "Virginia", "West Virginia"],
            territories: ["American Samoa", "Guam", "Northern Mariana Islands", "Puerto Rico", "U.S. Virgin Islands"]
        };

        const territoryUrls = {
            "American Samoa": "https://raw.githubusercontent.com/bradinator33/TPG-Tools/refs/heads/main/AmericanSamoa.geojson",
            "Guam": "https://raw.githubusercontent.com/bradinator33/TPG-Tools/refs/heads/main/Guam.geojson",
            "Northern Mariana Islands": "https://raw.githubusercontent.com/bradinator33/TPG-Tools/refs/heads/main/NMI.geojson",
            "Puerto Rico": "https://raw.githubusercontent.com/bradinator33/TPG-Tools/refs/heads/main/PR.geojson",
            "U.S. Virgin Islands": "https://raw.githubusercontent.com/bradinator33/TPG-Tools/refs/heads/main/USVI.geojson"
        };

        // --- INITIALIZATION ---
        function initMap() {
            map = L.map('map').setView([39.8283, -98.5795], 4);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            boundaryLayer = L.geoJSON(null, { style: { color: "#22c55e", weight: 2, opacity: 0.8, fill: false } }).addTo(map);
            
            populateStateSelector();
            document.getElementById('generateBtn').addEventListener('click', handleGeneration);
            document.getElementById('regionSelector').addEventListener('change', handleRegionSelect);
            document.getElementById('clearSelectionBtn').addEventListener('click', clearStateSelection);
        }

        function populateStateSelector() {
            const selector = document.getElementById('stateSelector');
            stateNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                selector.appendChild(option);
            });
        }
        
        function handleRegionSelect(event) {
            const selectedRegion = event.target.value;
            const stateSelector = document.getElementById('stateSelector');
            const statesToSelect = regionPresets[selectedRegion] || [];

            for (const option of stateSelector.options) {
                option.selected = statesToSelect.includes(option.value);
            }
        }

        function clearStateSelection() {
            const stateSelector = document.getElementById('stateSelector');
            for (const option of stateSelector.options) {
                option.selected = false;
            }
            document.getElementById('regionSelector').value = "";
        }

        // --- UI & STATUS HANDLING ---
        function showLoader(text) {
            const loader = document.getElementById('loader');
            loader.textContent = text;
            loader.style.display = 'block';
            document.getElementById('output').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('output').style.display = 'block';
            document.getElementById('generateBtn').disabled = false;
        }

        function updateOutput(html) {
            document.getElementById('output').innerHTML = html;
        }
        
        function updateMap(lat, lon, locationData) {
            const location = L.latLng(lat, lon);
            if (currentPin) {
                map.removeLayer(currentPin);
            }
            currentPin = L.marker(location).addTo(map);
            
            let popupContent = `<b>${lat.toFixed(5)}, ${lon.toFixed(5)}</b>`;
            if(locationData && locationData.state) {
                 popupContent += `<br>${locationData.county || 'N/A'}, ${locationData.state}`;
            }
            currentPin.bindPopup(popupContent).openPopup();
            
            if (!boundaryLayer.getBounds().isValid()) {
                 map.setView(location, 6);
            }
        }
        
        // --- CORE LOGIC ---
        async function handleGeneration() {
            const selectedStates = Array.from(document.getElementById('stateSelector').selectedOptions).map(opt => opt.value);
            
            boundaryLayer.clearLayers();
            if(currentPin) map.removeLayer(currentPin);
            updateOutput('Click the button to generate coordinates.');

            if (selectedStates.length > 0) {
                await generateLocationInStates(selectedStates);
            } else {
                await generateLocationInUSA();
            }
        }

        async function generateLocationInStates(states) {
            showLoader('Fetching state boundaries...');
            
            try {
                const geojsonPromises = states.map(fetchStateGeoJSON);
                const geojsonArray = await Promise.all(geojsonPromises);
                
                boundaryLayer.addData(geojsonArray);
                map.fitBounds(boundaryLayer.getBounds());
                
                showLoader('Finding a valid point...');
                
                let validPoint = null;
                let attempts = 0;
                
                // **FIX:** Instead of one giant bounding box, pick a random state from the selection
                // on each attempt and generate a point within its smaller, more relevant bounding box.
                while (!validPoint && attempts < 500) {
                    // 1. Pick a random feature (state/territory) from the fetched array.
                    const randomIndex = Math.floor(Math.random() * geojsonArray.length);
                    const randomFeature = geojsonArray[randomIndex];
                    
                    // 2. Get the bounding box for just that single feature.
                    const singleBbox = turf.bbox(randomFeature);
                    
                    // 3. Generate a random point within that smaller bounding box.
                    const randomPoint = turf.randomPoint(1, { bbox: singleBbox }).features[0];
                    
                    // 4. Check if the point is actually inside that feature's polygon.
                    if (turf.booleanPointInPolygon(randomPoint, randomFeature)) {
                        const lon = randomPoint.geometry.coordinates[0];
                        const lat = randomPoint.geometry.coordinates[1];
                        validPoint = { lat, lon, state: randomFeature.properties.name };
                    }
                    attempts++;
                }

                if (validPoint) {
                    showLoader('Fetching address details...');
                    const locationDetails = await checkIfValidUSLocation(validPoint.lat, validPoint.lon);
                    hideLoader();
                    
                    validPoint.county = locationDetails.county || 'N/A';

                    const locationText = `${validPoint.lat.toFixed(5)}, ${validPoint.lon.toFixed(5)}<br>${validPoint.county}, ${validPoint.state}`;
                    updateOutput(locationText);
                    updateMap(validPoint.lat, validPoint.lon, { state: validPoint.state, county: validPoint.county });
                } else {
                    hideLoader();
                    updateOutput('Could not find a point in the selected states. Please try again.');
                }

            } catch (error) {
                console.error("Error fetching or processing state boundaries:", error);
                hideLoader();
                updateOutput(`<span style="color: red;">Error: ${error.message}</span>`);
            }
        }

        async function fetchStateGeoJSON(stateName) {
            if (stateGeoJsonCache.has(stateName)) {
                return stateGeoJsonCache.get(stateName);
            }
            
            let url;
            if (territoryUrls[stateName]) {
                url = territoryUrls[stateName];
            } else {
                const urlName = stateName.toLowerCase();
                url = `https://raw.githubusercontent.com/glynnbird/usstatesgeojson/refs/heads/master/${urlName}.geojson`;
            }
            
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Could not fetch boundary for ${stateName}`);
            }
            const geojson = await response.json();
            
            // **FIX:** Standardize the GeoJSON to always be a Feature object,
            // handling raw geometries, Features, and FeatureCollections.
            let feature;
            if (geojson.type === 'Feature') {
                feature = geojson;
            } else if (geojson.type === 'FeatureCollection') {
                feature = geojson.features[0];
            } else { 
                // Assumes it's a raw geometry (e.g., Polygon) and wraps it in a Feature.
                feature = turf.feature(geojson); 
            }

            feature.properties = feature.properties || {};
            feature.properties.name = stateName;

            stateGeoJsonCache.set(stateName, feature);
            return feature;
        }

        async function generateLocationInUSA() {
            showLoader('Finding a valid point in the US...');
            
            let validLocationData = null;
            let coord;
            let attempts = 0;

            while (!validLocationData && attempts < 100) {
                const region = getRandomUSRegion();
                coord = getRandomCoordinateInRegion(region);
                const locationData = await checkIfValidUSLocation(coord.lat, coord.lon);
                if (locationData.valid && locationData.county !== "Unknown") {
                    validLocationData = locationData;
                }
                attempts++;
            }
            
            hideLoader();

            if (validLocationData) {
                const locationText = `${coord.lat.toFixed(5)}, ${coord.lon.toFixed(5)}<br>${validLocationData.county}, ${validLocationData.state}`;
                updateOutput(locationText);
                updateMap(coord.lat, coord.lon, validLocationData);
                map.fitBounds([ [24.8, -124.72], [49.0, -66.8] ]);
            } else {
                updateOutput('Could not find a valid US location after many attempts. Please try again.');
            }
        }

        function getRandomUSRegion() {
            const regions = [
                { name: "Contiguous US", minLat: 24.8, maxLat: 49.0, minLon: -124.72, maxLon: -66.8 },
                { name: "Hawaii", minLat: 18.8, maxLat: 22.4, minLon: -160.4, maxLon: -154.1 },
                { name: "Alaska", minLat: 54.0, maxLat: 71.5, minLon: -179.0, maxLon: -129.5 }
            ];
            let rand = Math.random();
            if (rand < 0.98) return regions[0];
            if (rand < 0.99) return regions[2];
            return regions[1];
        }

        function getRandomCoordinateInRegion(region) {
            const lat = Math.random() * (region.maxLat - region.minLat) + region.minLat;
            const lon = Math.random() * (region.maxLon - region.minLon) + region.minLon;
            return { lat, lon };
        }

        async function checkIfValidUSLocation(lat, lon) {
            try {
                const url = `https://nominatim.openstreetmap.org/reverse?lat=${lat}&lon=${lon}&format=json&accept-language=en`;
                const response = await fetch(url, { headers: { 'User-Agent': 'RandomCoordGenerator/1.0' } });
                if (!response.ok) return { valid: false };
                const data = await response.json();
                if (data && data.address && (data.address.country_code === "us" || data.address.country_code === "as" || data.address.country_code === "gu" || data.address.country_code === "mp" || data.address.country_code === "pr" || data.address.country_code === "vi")) {
                    return {
                        valid: true,
                        state: data.address.state || "Unknown",
                        county: data.address.county || data.address.city || "N/A" // Fallback for territories
                    };
                }
            } catch (error) {
                console.error("Nominatim API error:", error);
            }
            return { valid: false };
        }

    </script>
</body>
</html>
