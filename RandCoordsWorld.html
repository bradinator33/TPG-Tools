<!DOCTYPE html>
<html lang="en">
<head>
    <link rel="icon" type="image/png" href="MapinatorPFP.png">
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>World Random Coordinate Generator</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src='https://unpkg.com/@turf/turf@6/turf.min.js'></script>
    <style>
        body { 
            font-family: sans-serif; 
            padding: 1em; 
            margin: 0;
            display: flex;
            flex-direction: column;
            height: 100vh;
            box-sizing: border-box;
        }
        h1 { margin: 0 0 0.2em 0; }
        h3 { margin: 0 0 1em 0; font-weight: normal; }

        .app-container {
            display: flex;
            gap: 20px;
            flex: 1;
            min-height: 0;
        }

        .sidebar {
            flex: 1;
            max-width: 400px;
            min-width: 300px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
        }

        .map-container {
            flex: 2;
            border: 1px solid #ccc;
            position: relative;
        }

        #map {
            width: 100%;
            height: 100%;
        }

        #countrySelector {
            width: 100%;
            height: 200px;
            min-height: 100px;
            max-height: 500px;
            vertical-align: top;
            resize: vertical;
        }

        label {
            display: block;
            margin-top: 1em;
            font-weight: bold;
        }

        select {
            width: 100%;
        }

        button {
            margin-top: 1em;
            padding: 5px 10px;
            cursor: pointer;
        }

        button:disabled {
            cursor: not-allowed;
            color: #aaa;
        }

        #output {
            margin-top: 1em;
            font-family: monospace;
            font-size: 0.95em;
            background-color: #f4f4f4;
            padding: 0.5em;
            border: 1px solid #ddd;
            height: 120px; 
            overflow-y: auto;
        }

        #loader {
            display: none;
            margin-top: 1em;
            font-style: italic;
            color: #555;
        }

        .controls-group {
            margin-top: 1em;
        }

        .num-input-wrapper {
            margin-top: 0.5em;
        }

        #numToGenerate {
            width: 60px;
        }
    </style>
</head>
<body onload="initMap()">

    <h1>World Random Coordinate Generator</h1>
    <h3>Select a region or individual countries/territories. Leave blank to generate a location anywhere in the world.</h3>

    <div class="app-container">
        <div class="sidebar">
            <label for="regionSelector">Region Presets:</label>
            <select id="regionSelector">
                <option value="">-- Select a Region --</option>
                <option value="africa">Africa</option>
                <option value="asia">Asia</option>
                <option value="europe">Europe</option>
                <option value="north_america">North America</option>
                <option value="central_america">Central America</option>
                <option value="south_america">South America</option>
                <option value="middle_east">Middle East</option>
                <option value="balkans">Balkans</option>
                <option value="oceania">Oceania</option>
                <option value="territory">Territories & Dependencies</option>
                <option value="polar">Polar & Remote</option>
            </select>

            <label for="countrySelector">Select Countries (Adjust size via handle):</label>
            <select id="countrySelector" multiple></select>
            
            <button id="clearSelectionBtn">Clear Selection</button>
            <button id="downloadBtn" disabled>Download Locations as CSV</button>

            <div class="controls-group">
                <button id="generateBtn">Generate Single Location</button>
            </div>

            <div class="controls-group">
                <label for="numToGenerate">Number of Locations:</label>
                <div class="num-input-wrapper">
                    <input type="number" id="numToGenerate" value="10" min="1" max="1000">
                    <button id="generateMultipleBtn">Generate Multiple Locations</button>
                </div>
            </div>

            <div id="loader">Finding a valid point...</div>
            <div id="output">Click a button to generate coordinates.</div>
        </div>

        <div class="map-container">
            <div id="map"></div>
        </div>
    </div>

    <script>
        let map;
        let pinsLayer = null;
        let boundaryLayer = null;
        const countryCache = new Map();
        let generatedLocations = [];
        let shouldDrawBoundary = true;

        const countryNames = {
            "ABW": "Aruba", "AFG": "Afghanistan", "AGO": "Angola", "AIA": "Anguilla", "ALB": "Albania", 
            "ALD": "Aland Islands", "AND": "Andorra", "ARE": "United Arab Emirates", "ARG": "Argentina", 
            "ARM": "Armenia", "ASM": "American Samoa", "ATA": "Antarctica", "ATC": "Ashmore and Cartier Islands", 
            "ATF": "French Southern Territories", "ATG": "Antigua and Barbuda", "AUS": "Australia", 
            "AUT": "Austria", "AZE": "Azerbaijan", "BDI": "Burundi", "BEL": "Belgium", "BEN": "Benin", 
            "BFA": "Burkina Faso", "BGD": "Bangladesh", "BGR": "Bulgaria", "BHR": "Bahrain", 
            "BHS": "Bahamas", "BIH": "Bosnia and Herzegovina", "BJN": "Bajo Nuevo Bank", 
            "BLM": "Saint Barthelemy", "BLR": "Belarus", "BLZ": "Belize", "BMU": "Bermuda", 
            "BOL": "Bolivia", "BRA": "Brazil", "BRB": "Barbados", "BRN": "Brunei", "BTN": "Bhutan", 
            "BWA": "Botswana", "CAF": "Central African Republic", "CAN": "Canada", "CHE": "Switzerland", 
            "CHL": "Chile", "CHN": "China", "CIV": "Ivory Coast", "CLP": "Clipperton Island", 
            "CMR": "Cameroon", "CNM": "Cyprus (Buffer Zone)", "COD": "DR Congo", "COG": "Congo", 
            "COK": "Cook Islands", "COL": "Colombia", "COM": "Comoros", "CPV": "Cape Verde", 
            "CRI": "Costa Rica", "CSI": "Coral Sea Islands", "CUB": "Cuba", "CUW": "Curacao", 
            "CYM": "Cayman Islands", "CYN": "Northern Cyprus", "CYP": "Cyprus", "CZE": "Czech Republic", 
            "DEU": "Germany", "DJI": "Djibouti", "DMA": "Dominica", "DNK": "Denmark", 
            "DOM": "Dominican Republic", "DZA": "Algeria", "ECU": "Ecuador", "EGY": "Egypt", 
            "ERI": "Eritrea", "ESB": "Dhekelia Sovereign Base Area", "ESP": "Spain", "EST": "Estonia", 
            "ETH": "Ethiopia", "FIN": "Finland", "FJI": "Fiji", "FLK": "Falkland Islands", 
            "FRA": "France", "FRO": "Faroe Islands", "FSM": "Micronesia", "GAB": "Gabon", 
            "GBR": "United Kingdom", "GEO": "Georgia", "GGY": "Guernsey", "GHA": "Ghana", 
            "GIB": "Gibraltar", "GIN": "Guinea", "GMB": "Gambia", "GNB": "Guinea-Bissau", 
            "GNQ": "Equatorial Guinea", "GRC": "Greece", "GRD": "Grenada", "GRL": "Greenland", 
            "GTM": "Guatemala", "GUM": "Guam", "GUY": "Guyana", "HKG": "Hong Kong", 
            "HMD": "Heard Island and McDonald Islands", "HND": "Honduras", "HRV": "Croatia", 
            "HTI": "Haiti", "HUN": "Hungary", "IDN": "Indonesia", "IMN": "Isle of Man", 
            "IND": "India", "IOA": "Indian Ocean Territories", "IOT": "British Indian Ocean Territory", 
            "IRL": "Ireland", "IRN": "Iran", "IRQ": "Iraq", "ISL": "Iceland", "ISR": "Israel", 
            "ITA": "Italy", "JAM": "Jamaica", "JEY": "Jersey", "JOR": "Jordan", "JPN": "Japan", 
            "KAS": "Kashmir", "KAZ": "Kazakhstan", "KEN": "Kenya", "KGZ": "Kyrgyzstan", 
            "KHM": "Cambodia", "KIR": "Kiribati", "KNA": "Saint Kitts and Nevis", "KOR": "South Korea", 
            "KOS": "Kosovo", "KWT": "Kuwait", "LAO": "Laos", "LBN": "Lebanon", "LBR": "Liberia", 
            "LBY": "Libya", "LCA": "Saint Lucia", "LIE": "Liechtenstein", "LKA": "Sri Lanka", 
            "LSO": "Lesotho", "LTU": "Lithuania", "LUX": "Luxembourg", "LVA": "Latvia", 
            "MAC": "Macau", "MAF": "Saint Martin", "MAR": "Morocco", "MCO": "Monaco", 
            "MDA": "Moldova", "MDG": "Madagascar", "MDV": "Maldives", "MEX": "Mexico", 
            "MHL": "Marshall Islands", "MKD": "North Macedonia", "MLI": "Mali", "MLT": "Malta", 
            "MMR": "Myanmar", "MNE": "Montenegro", "MNG": "Mongolia", "MNP": "Northern Mariana Islands", 
            "MOZ": "Mozambique", "MRT": "Mauritania", "MSR": "Montserrat", "MUS": "Mauritius", 
            "MWI": "Malawi", "MYS": "Malaysia", "NAM": "Namibia", "NCL": "New Caledonia", 
            "NER": "Niger", "NFK": "Norfolk Island", "NGA": "Nigeria", "NIC": "Nicaragua", 
            "NIU": "Niue", "NLD": "Netherlands", "NOR": "Norway", "NPL": "Nepal", 
            "NRU": "Nauru", "NZL": "New Zealand", "OMN": "Oman", "PAK": "Pakistan", 
            "PAN": "Panama", "PCN": "Pitcairn Islands", "PER": "Peru", "PHL": "Philippines", 
            "PLW": "Palau", "PNG": "Papua New Guinea", "POL": "Poland", "PRI": "Puerto Rico", 
            "PRK": "North Korea", "PRT": "Portugal", "PRY": "Paraguay", "PSX": "Palestine", 
            "PYF": "French Polynesia", "QAT": "Qatar", "ROU": "Romania", "RUS": "Russia", 
            "RWA": "Rwanda", "SAH": "Western Sahara", "SAU": "Saudi Arabia", "SDN": "Sudan", 
            "SDS": "South Sudan", "SEN": "Senegal", "SGP": "Singapore", "SGS": "South Georgia", 
            "SHN": "Saint Helena", "SLB": "Solomon Islands", "SLE": "Sierra Leone", 
            "SLV": "El Salvador", "SMR": "San Marino", "SOM": "Somalia", "SPM": "Saint Pierre and Miquelon", 
            "SRB": "Serbia", "STP": "Sao Tome and Principe", "SUR": "Suriname", "SVK": "Slovakia", 
            "SVN": "Slovenia", "SWE": "Sweden", "SWZ": "Swaziland", "SXM": "Sint Maarten", 
            "SYC": "Seychelles", "SYR": "Syria", "TCA": "Turks and Caicos", "TCD": "Chad", 
            "TGO": "Togo", "THA": "Thailand", "TJK": "Tajikistan", "TKM": "Turkmenistan", 
            "TLS": "Timor-Leste", "TON": "Tonga", "TTO": "Trinidad and Tobago", "TUN": "Tunisia", 
            "TUR": "Turkey", "TUV": "Tuvalu", "TWN": "Taiwan", "TZA": "Tanzania", "UGA": "Uganda", 
            "UKR": "Ukraine", "UMI": "US Minor Outlying Islands", "URY": "Uruguay", 
            "USA": "United States", "UZB": "Uzbekistan", "VAT": "Vatican City", 
            "VCT": "Saint Vincent and the Grenadines", "VEN": "Venezuela", "VGB": "British Virgin Islands", 
            "VIR": "US Virgin Islands", "VNM": "Vietnam", "VUT": "Vanuatu", "WLF": "Wallis and Futuna", 
            "WSM": "Samoa", "YEM": "Yemen", "ZAF": "South Africa", "ZMB": "Zambia", "ZWE": "Zimbabwe"
        };

        const countryAreas = {
            "ABW": 180, "AFG": 652230, "AGO": 1246700, "AIA": 91, "ALB": 28748, "ALD": 1580, "AND": 468, 
            "ARE": 83600, "ARG": 2780400, "ARM": 29743, "ASM": 199, "ATA": 14000000, "ATC": 5, "ATF": 7747, 
            "ATG": 442, "AUS": 7692024, "AUT": 83871, "AZE": 86600, "BDI": 27834, "BEL": 30528, "BEN": 112622, 
            "BFA": 274200, "BGD": 147570, "BGR": 110879, "BHR": 765, "BHS": 13878, "BIH": 51129, "BJN": 1, 
            "BLM": 25, "BLR": 207600, "BLZ": 22966, "BMU": 54, "BOL": 1098581, "BRA": 8515767, "BRB": 430, 
            "BRN": 5765, "BTN": 38394, "BWA": 581730, "CAF": 622984, "CAN": 9984670, "CHE": 41277, "CHL": 756102, 
            "CHN": 9596961, "CIV": 322463, "CLP": 6, "CMR": 475442, "CNM": 346, "COD": 2344858, "COG": 342000, 
            "COK": 236, "COL": 1141748, "COM": 2235, "CPV": 4033, "CRI": 51100, "CSI": 3, "CUB": 109884, 
            "CUW": 444, "CYM": 264, "CYN": 3355, "CYP": 9251, "CZE": 78866, "DEU": 357022, "DJI": 23200, 
            "DMA": 751, "DNK": 43094, "DOM": 48671, "DZA": 2381741, "ECU": 283561, "EGY": 1002450, "ERI": 117600, 
            "ESB": 130, "ESP": 505992, "EST": 45227, "ETH": 1104300, "FIN": 338424, "FJI": 18274, "FLK": 12173, 
            "FRA": 643801, "FRO": 1393, "FSM": 702, "GAB": 267667, "GBR": 243610, "GEO": 69700, "GGY": 78, 
            "GHA": 238533, "GIB": 7, "GIN": 245857, "GMB": 11295, "GNB": 36125, "GNQ": 28051, "GRC": 131957, 
            "GRD": 344, "GRL": 2166086, "GTM": 108889, "GUM": 544, "GUY": 214969, "HKG": 1106, "HMD": 372, 
            "HND": 112492, "HRV": 56594, "HTI": 27750, "HUN": 93028, "IDN": 1904569, "IMN": 572, "IND": 3287263, 
            "IOA": 135, "IOT": 60, "IRL": 70273, "IRN": 1648195, "IRQ": 438317, "ISL": 103000, "ISR": 20770, 
            "ITA": 301340, "JAM": 10991, "JEY": 116, "JOR": 89342, "JPN": 377975, "KAS": 222236, "KAZ": 2724900, 
            "KEN": 580367, "KGZ": 199951, "KHM": 181035, "KIR": 811, "KNA": 261, "KOR": 100210, "KOS": 10887, 
            "KWT": 17818, "LAO": 236800, "LBN": 10452, "LBR": 111369, "LBY": 1759540, "LCA": 616, "LIE": 160, 
            "LKA": 65610, "LSO": 30355, "LTU": 65300, "LUX": 2586, "LVA": 64589, "MAC": 33, "MAF": 54, 
            "MAR": 446550, "MCO": 2, "MDA": 33851, "MDG": 587041, "MDV": 298, "MEX": 1964375, "MHL": 181, 
            "MKD": 25713, "MLI": 1240192, "MLT": 316, "MMR": 676578, "MNE": 13812, "MNG": 1564116, "MNP": 464, 
            "MOZ": 799380, "MRT": 1030700, "MSR": 102, "MUS": 2040, "MWI": 118484, "MYS": 330803, "NAM": 824292, 
            "NCL": 18575, "NER": 1267000, "NFK": 36, "NGA": 923768, "NIC": 130370, "NIU": 260, "NLD": 41543, 
            "NOR": 323802, "NPL": 147181, "NRU": 21, "NZL": 268021, "OMN": 309500, "PAK": 796095, "PAN": 75417, 
            "PCN": 47, "PER": 1285216, "PHL": 300000, "PLW": 459, "PNG": 462840, "POL": 312685, "PRI": 9104, 
            "PRK": 120540, "PRT": 92212, "PRY": 406752, "PSX": 6220, "PYF": 4167, "QAT": 11586, "ROU": 238391, 
            "RUS": 17098242, "RWA": 26338, "SAH": 266000, "SAU": 2149690, "SDN": 1861484, "SDS": 644329, 
            "SEN": 196722, "SGP": 728, "SGS": 3903, "SHN": 121, "SLB": 28896, "SLE": 71740, "SLV": 21041, 
            "SMR": 61, "SOM": 637657, "SPM": 242, "SRB": 77474, "STP": 964, "SUR": 163820, "SVK": 49035, 
            "SVN": 20273, "SWE": 450295, "SWZ": 17364, "SXM": 34, "SYC": 452, "SYR": 185180, "TCA": 948, 
            "TCD": 1284000, "TGO": 56785, "THA": 513120, "TJK": 144100, "TKM": 488100, "TLS": 14874, "TON": 747, 
            "TTO": 5130, "TUN": 163610, "TUR": 783562, "TUV": 26, "TWN": 36193, "TZA": 947303, "UGA": 241038, 
            "UKR": 603500, "UMI": 34, "URY": 176215, "USA": 9833517, "UZB": 447400, "VAT": 1, "VCT": 389, 
            "VEN": 912050, "VGB": 151, "VIR": 346, "VNM": 331210, "VUT": 12189, "WLF": 142, "WSM": 2831, 
            "YEM": 527968, "ZAF": 1219090, "ZMB": 752618, "ZWE": 390757
        };

        const regionPresets = {
            africa: ["AGO", "BDI", "BEN", "BFA", "BWA", "CAF", "CIV", "CMR", "COD", "COG", "COM", "CPV", "DJI", "DZA", "EGY", "ERI", "ETH", "GAB", "GHA", "GIN", "GMB", "GNB", "GNQ", "KEN", "LBR", "LBY", "LSO", "MAR", "MDG", "MLI", "MOZ", "MRT", "MUS", "MWI", "NAM", "NER", "NGA", "RWA", "SAH", "SDN", "SDS", "SEN", "SOM", "STP", "SWZ", "SYC", "TCD", "TGO", "TUN", "TZA", "UGA", "ZAF", "ZMB", "ZWE"],
            asia: ["AFG", "ARE", "ARM", "AZE", "BGD", "BHR", "BRN", "BTN", "CHN", "GEO", "HKG", "IDN", "IND", "IRN", "IRQ", "ISR", "JOR", "JPN", "KAS", "KAZ", "KGZ", "KHM", "KOR", "KWT", "LAO", "LBN", "LKA", "MAC", "MDV", "MMR", "MNG", "MYS", "NPL", "OMN", "PAK", "PHL", "PRK", "PSX", "QAT", "SAU", "SGP", "SYR", "THA", "TJK", "TKM", "TLS", "TUR", "TWN", "UZB", "VNM", "YEM"],
            europe: ["ALB", "AND", "AUT", "BEL", "BGR", "BIH", "BLR", "CHE", "CYN", "CYP", "CZE", "DEU", "DNK", "ESP", "EST", "FIN", "FRA", "GBR", "GRC", "HRV", "HUN", "IRL", "ISL", "ITA", "KOS", "LIE", "LTU", "LUX", "LVA", "MCO", "MDA", "MKD", "MLT", "MNE", "NLD", "NOR", "POL", "PRT", "ROU", "RUS", "SMR", "SRB", "SVK", "SVN", "SWE", "UKR", "VAT"],
            north_america: ["AIA", "ATG", "BHS", "BLZ", "BMU", "CAN", "CRI", "CUB", "CYM", "DMA", "DOM", "GRL", "GTM", "HND", "HTI", "JAM", "KNA", "LCA", "MEX", "MSR", "NIC", "PAN", "PRI", "SLV", "SPM", "TCA", "TTO", "USA", "VCT", "VGB", "VIR"],
            central_america: ["BLZ", "CRI", "GTM", "HND", "NIC", "PAN", "SLV"],
            south_america: ["ARG", "BOL", "BRA", "CHL", "COL", "ECU", "FLK", "GUY", "PER", "PRY", "SUR", "URY", "VEN"],
            middle_east: ["ARE", "BHR", "EGY", "IRN", "IRQ", "ISR", "JOR", "KWT", "LBN", "OMN", "PSX", "QAT", "SAU", "SYR", "TUR", "YEM"],
            balkans: ["ALB", "BIH", "BGR", "HRV", "GRC", "KOS", "MKD", "MNE", "ROU", "SRB", "SVN"],
            oceania: ["ASM", "AUS", "COK", "CSI", "FJI", "FSM", "GUM", "KIR", "MHL", "MNP", "NCL", "NFK", "NIU", "NRU", "NZL", "PCN", "PLW", "PNG", "PYF", "SLB", "TON", "TUV", "VUT", "WLF", "WSM"],
            territory: ["ABW", "AIA", "ALD", "ASM", "ATC", "ATF", "ATG", "AWB", "BJN", "BLM", "BMU", "BRB", "CLP", "CNM", "COK", "CSI", "CUW", "CYM", "CYN", "DMA", "ESB", "FLK", "FRO", "GGY", "GIB", "GRL", "GUM", "HKG", "IMN", "IOA", "IOT", "JEY", "KNA", "LCA", "MAC", "MAF", "MNP", "MSR", "NCL", "NFK", "NIU", "PCN", "PRI", "PYF", "SGS", "SHN", "SPM", "SXM", "TCA", "TTO", "UMI", "VCT", "VGB", "VIR", "WLF"],
            polar: ["ATA", "ATC", "ATF", "CLP", "GRL", "HMD", "IOA", "IOT", "SGS", "SHN"]
        };

        function initMap() {
            map = L.map('map').setView([20, 0], 2);
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors'
            }).addTo(map);
            boundaryLayer = L.geoJSON(null, { style: { color: "#2563eb", weight: 2, opacity: 0.8, fill: false } }).addTo(map);
            pinsLayer = L.featureGroup().addTo(map);
            
            populateCountrySelector();
            document.getElementById('generateBtn').addEventListener('click', handleSingleGeneration);
            document.getElementById('generateMultipleBtn').addEventListener('click', handleMultipleGeneration);
            document.getElementById('downloadBtn').addEventListener('click', downloadCSV);
            document.getElementById('regionSelector').addEventListener('change', handleRegionSelect);
            document.getElementById('clearSelectionBtn').addEventListener('click', clearSelection);
        }

        function populateCountrySelector() {
            const selector = document.getElementById('countrySelector');
            const sortedCodes = Object.keys(countryNames).sort((a, b) => countryNames[a].localeCompare(countryNames[b]));
            sortedCodes.forEach(code => {
                const option = document.createElement('option');
                option.value = code;
                option.textContent = `${countryNames[code]} (${code})`;
                selector.appendChild(option);
            });
        }
        
        function handleRegionSelect(event) {
            const selectedRegion = event.target.value;
            const selector = document.getElementById('countrySelector');
            const codesInRegion = regionPresets[selectedRegion] || [];
            for (const option of selector.options) {
                option.selected = codesInRegion.includes(option.value);
            }
        }

        function clearSelection() {
            const selector = document.getElementById('countrySelector');
            for (const option of selector.options) {
                option.selected = false;
            }
            document.getElementById('regionSelector').value = "";
            boundaryLayer.clearLayers();
        }

        function showLoader(text) {
            const loader = document.getElementById('loader');
            loader.textContent = text;
            loader.style.display = 'block';
            document.getElementById('output').style.display = 'none';
            document.getElementById('generateBtn').disabled = true;
            document.getElementById('generateMultipleBtn').disabled = true;
        }

        function hideLoader() {
            document.getElementById('loader').style.display = 'none';
            document.getElementById('output').style.display = 'block';
            document.getElementById('generateBtn').disabled = false;
            document.getElementById('generateMultipleBtn').disabled = false;
        }

        function updateOutput(html) {
            document.getElementById('output').innerHTML = html;
        }
        
        function addPointToMap(lat, lon, locationData) {
            const location = L.latLng(lat, lon);
            let popupContent = `<b>${locationData.country} (${locationData.code})</b><br>${lat.toFixed(5)}, ${lon.toFixed(5)}`;
            L.marker(location).addTo(pinsLayer).bindPopup(popupContent);
        }

        function resetUI() {
            boundaryLayer.clearLayers();
            pinsLayer.clearLayers();
            generatedLocations = [];
            document.getElementById('downloadBtn').disabled = true;
            updateOutput('Click a button to generate coordinates.');
        }

        async function handleSingleGeneration() {
            resetUI();
            shouldDrawBoundary = true;
            const location = await generatePoint();
            if (location) {
                generatedLocations.push(location);
                addPointToMap(location.lat, location.lon, location);
                updateOutput(`${location.lat.toFixed(5)}, ${location.lon.toFixed(5)}<br>${location.country} (${location.code})`);
                document.getElementById('downloadBtn').disabled = false;
                map.setView([location.lat, location.lon], 5);
            }
            hideLoader();
        }
        
        async function handleMultipleGeneration() {
            resetUI();
            shouldDrawBoundary = false; 
            const numToGenerate = parseInt(document.getElementById('numToGenerate').value, 10);
            if (isNaN(numToGenerate) || numToGenerate < 1) {
                alert("Please enter a valid number of locations.");
                return;
            }

            for (let i = 1; i <= numToGenerate; i++) {
                showLoader(`Generating ${i} of ${numToGenerate}...`);
                const location = await generatePoint();
                if (location) {
                    generatedLocations.push(location);
                    addPointToMap(location.lat, location.lon, location);
                }
            }
            
            hideLoader();
            const outputHtml = generatedLocations.map(loc => `<li>${loc.lat.toFixed(5)}, ${loc.lon.toFixed(5)} (${loc.country})</li>`).join('');
            updateOutput(`<ul>${outputHtml}</ul>`);
            document.getElementById('downloadBtn').disabled = false;
            if (pinsLayer.getLayers().length > 0) {
                map.fitBounds(pinsLayer.getBounds().pad(0.1));
            }
        }

        async function generatePoint() {
            const selectedCodes = Array.from(document.getElementById('countrySelector').selectedOptions).map(opt => opt.value);
            
            let codesToPool = selectedCodes.length > 0 ? selectedCodes : Object.keys(countryAreas);
            
            const totalArea = codesToPool.reduce((sum, code) => sum + (countryAreas[code] || 0), 0);
            let random = Math.random() * totalArea;
            let targetCode = codesToPool[codesToPool.length - 1];
            
            for (const code of codesToPool) {
                random -= (countryAreas[code] || 0);
                if (random <= 0) {
                    targetCode = code;
                    break;
                }
            }

            return await generatePointInCountryBoundary(targetCode);
        }

        async function generatePointInCountryBoundary(code) {
            try {
                const geojson = await fetchGeoJSON(code);
                if (!geojson) return null;

                if (shouldDrawBoundary) {
                    boundaryLayer.addData(geojson);
                }

                showLoader(`Finding valid point in ${countryNames[code]}...`);
                const bbox = turf.bbox(geojson);
                let attempts = 0;
                while (attempts < 1000) {
                    attempts++;
                    const lat = Math.random() * (bbox[3] - bbox[1]) + bbox[1];
                    const lon = Math.random() * (bbox[2] - bbox[0]) + bbox[0];
                    const pt = turf.point([lon, lat]);
                    
                    if (turf.booleanPointInPolygon(pt, geojson)) {
                        return { lat, lon, country: countryNames[code], code: code };
                    }
                }
            } catch (error) {
                console.error("Error generating point:", error);
            }
            return null;
        }

        async function fetchGeoJSON(code) {
            if (countryCache.has(code)) return countryCache.get(code);
            const url = `https://raw.githubusercontent.com/LonnyGomes/CountryGeoJSONCollection/master/geojson/${code}.geojson`;
            try {
                const response = await fetch(url);
                if (!response.ok) throw new Error(`Could not fetch boundary for ${code}`);
                const data = await response.json();
                countryCache.set(code, data);
                return data;
            } catch (error) {
                return null;
            }
        }

        function downloadCSV() {
            if (generatedLocations.length === 0) return;
            const headers = "Latitude,Longitude,Country,ISO_Code";
            const csvContent = [
                headers,
                ...generatedLocations.map(loc => `${loc.lat},${loc.lon},"${loc.country}","${loc.code}"`)
            ].join("\n");

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `world_locations_${Date.now()}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }

    </script>
</body>
</html>
